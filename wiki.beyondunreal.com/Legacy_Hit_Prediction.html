<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">

<!-- Mirrored from wiki.beyondunreal.com/Legacy:Hit_Prediction by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 16 Dec 2016 07:56:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8" />
<title>Legacy:Hit Prediction - Unreal Wiki</title>
<meta name="generator" content="MediaWiki 1.25.1" />
<link rel="alternate" type="application/x-wiki" title="Edit" href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction" />
<link rel="edit" title="Edit" href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction" />
<link rel="shortcut icon" href="w/uewiki-favicon.png" />
<link rel="search" type="application/opensearchdescription+xml" href="w/opensearch_desc.php" title="Unreal Wiki" />
<link rel="EditURI" type="application/rsd+xml" href="w/api251f.php?action=rsd" />
<link rel="alternate" hreflang="x-default" href="Legacy_Hit_Prediction.html" />
<link rel="copyright" href="Unreal_Wiki_Copyrights.html" />
<link rel="alternate" type="application/atom+xml" title="Unreal Wiki Atom feed" href="https://wiki.beyondunreal.com/Special:RecentChanges?feed=atom" />
<link rel="stylesheet" href="w/load2743.css?debug=false&amp;lang=en&amp;modules=ext.geshi.language.uscript%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.content.externallinks%7Cmediawiki.skinning.interface%7Cmediawiki.ui.button%7Cskins.monobook.styles&amp;only=styles&amp;skin=monobook&amp;*" />
<!--[if IE 6]><link rel="stylesheet" href="/w/skins/MonoBook/IE60Fixes.css?303" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" href="/w/skins/MonoBook/IE70Fixes.css?303" media="screen" /><![endif]--><meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="w/load484a.css?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=monobook&amp;*" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: wiki:resourceloader:filter:minify-css:7:29b70323345a439ab9ed7007e0c178a6 */</style>
<script src="w/load9316.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=monobook&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"Legacy","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":100,"wgPageName":"Legacy:Hit_Prediction","wgTitle":"Hit Prediction","wgCurRevisionId":3574,"wgRevisionId":3574,"wgArticleId":1412,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Legacy:Hit_Prediction","wgRelevantArticleId":1412,"wgIsProbablyEditable":true,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgCategoryTreePageCategoryOptions":"{\"mode\":0,\"hideprefix\":20,\"showcount\":true,\"namespaces\":false}"});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});
/* cache key: wiki:resourceloader:filter:minify-js:7:a5c52c063dc436c1ca7c9f456936a5e9 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
</head>
<body class="mediawiki ltr sitedir-ltr ns-100 ns-subject page-Legacy_Hit_Prediction skin-monobook action-view">
<div id="globalWrapper">
		<div id="column-content">
			<div id="content" class="mw-body" role="main">
				<a id="top"></a>
									<div id="siteNotice"><div id="localNotice" lang="en" dir="ltr"><p>Worst-case scenario: the UEd Goblin wipes the map and burns down your house.
</p></div></div>
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">Legacy:Hit Prediction</h1>

				<div id="bodyContent" class="mw-body-content">
					<div id="siteSub">From Unreal Wiki, The Unreal Engine Documentation Site</div>
					<div id="contentSub"></div>
										<div id="jump-to-nav" class="mw-jump">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>

					<!-- start content -->
					<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p>This is an Open Source implementation of the Hit Prediction for UT2003, which is explained at <a href="Legacy_Lag_Compensation.html" title="Legacy:Lag Compensation">Lag Compensation</a>.</p>
<p>Feel free to use and improve the code for whatever you want, but if you modify it, please let us know about the modifications.</p>
<p>I don't offer a download here because I don't think that the implementation is polished and "foolproof" enough yet.</p>
<p>This example implementation will use a modified Instagib gametype with only one modified gun.</p>
<p></p>
<div id="toc" class="toc">
<div id="toctitle">
<h2>Contents</h2>
</div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Sourcecode"><span class="tocnumber">1</span> <span class="toctext">Sourcecode</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#The_LocationTrail_class"><span class="tocnumber">1.1</span> <span class="toctext">The LocationTrail class</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#The_Game_Replication_class"><span class="tocnumber">1.2</span> <span class="toctext">The Game Replication class</span></a>
<ul>
<li class="toclevel-3 tocsection-4"><a href="#Discussion"><span class="tocnumber">1.2.1</span> <span class="toctext">Discussion</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-5"><a href="#The_Player_class"><span class="tocnumber">1.3</span> <span class="toctext">The Player class</span></a>
<ul>
<li class="toclevel-3 tocsection-6"><a href="#Discussion_2"><span class="tocnumber">1.3.1</span> <span class="toctext">Discussion</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="#The_Pawn_class"><span class="tocnumber">1.4</span> <span class="toctext">The Pawn class</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#Discussion_3"><span class="tocnumber">1.4.1</span> <span class="toctext">Discussion</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-9"><a href="#The_Weapon_class"><span class="tocnumber">1.5</span> <span class="toctext">The Weapon class</span></a>
<ul>
<li class="toclevel-3 tocsection-10"><a href="#Discussion_4"><span class="tocnumber">1.5.1</span> <span class="toctext">Discussion</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-11"><a href="#The_WeaponFire_class"><span class="tocnumber">1.6</span> <span class="toctext">The WeaponFire class</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Discussion_5"><span class="tocnumber">1.7</span> <span class="toctext">Discussion</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-13"><a href="#Related_Topics"><span class="tocnumber">2</span> <span class="toctext">Related Topics</span></a></li>
</ul>
</div>
<p></p>
<h2><span class="mw-headline" id="Sourcecode">Sourcecode</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=1" title="Edit section: Sourcecode">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<p>To make the source managable, I will post it in chunks and not in one whole, with a discussion for each chunk.</p>
<h3><span class="mw-headline" id="The_LocationTrail_class">The LocationTrail class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=2" title="Edit section: The LocationTrail class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> LocationTrail <span class="kw1">extends</span> <span class="kw8">Object</span>;
 
<span class="kw1">var</span> <span class="kw5">float</span> TimeStamp;
<span class="kw1">var</span> <span class="kw5">vector</span> <span class="kw7">Location</span>;
<span class="kw1">var</span> <span class="kw5">Rotator</span> <span class="kw7">Rotation</span>;
<span class="kw1">var</span> LocationTrail Next;
</pre></div>
</div>
<p>Simply a class to hold a trail node.</p>
<h3><span class="mw-headline" id="The_Game_Replication_class">The Game Replication class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=3" title="Edit section: The Game Replication class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> PredictionReplicationInfo <span class="kw1">extends</span> GameReplicationInfo;
 
<span class="kw1">var</span> <span class="kw5">float</span> PackageTimeStamp; <span class="co1">// Constantly replicated to the client to TimeStamp shot packages for prediction</span>
 
<span class="kw1">replication</span>
<span class="br0">{</span>
	<span class="kw1">reliable</span> <span class="kw2">if</span> <span class="br0">(</span> bNetDirty <span class="sy0">&amp;&amp;</span> <span class="br0">(</span><span class="kw7">Role</span> <span class="sy0">==</span> <span class="kw7">ROLE_Authority</span><span class="br0">)</span> <span class="br0">)</span>
		PackageTimeStamp;
<span class="br0">}</span>
 
 
<span class="kw1">function</span> <span class="kw4">Tick</span><span class="br0">(</span> <span class="kw5">float</span> DeltaTime<span class="br0">)</span>
<span class="br0">{</span>
	PackageTimeStamp <span class="sy0">=</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span>;
 
	<span class="kw6">Super</span>.<span class="kw4">Tick</span><span class="br0">(</span>DeltaTime<span class="br0">)</span>;
<span class="br0">}</span>
</pre></div>
</div>
<h4><span class="mw-headline" id="Discussion">Discussion</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=4" title="Edit section: Discussion">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p><b>Spark:</b> See <a href="Legacy_Lag_Compensation.html" title="Legacy:Lag Compensation">lag compensation</a> for a discussion why it's neccessary to replicate the servertime constantly. It might be desirable to find a better solution though...</p>
<h3><span class="mw-headline" id="The_Player_class">The Player class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=5" title="Edit section: The Player class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> PredictedPlayer <span class="kw1">extends</span> <span class="kw9">xPlayer</span>;
 
<span class="kw1">event</span> PlayerTick<span class="br0">(</span> <span class="kw5">float</span> DeltaTime <span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw6">Super</span>.<span class="me0">PlayerTick</span><span class="br0">(</span>DeltaTime<span class="br0">)</span>;
 
	<span class="co1">// Increase PackageTimeStamp for smooth interpolated hit prediction</span>
	PredictionReplicationInfo<span class="br0">(</span>GameReplicationInfo<span class="br0">)</span>.<span class="me0">PackageTimeStamp</span> <span class="sy0">+=</span> DeltaTime;
<span class="br0">}</span>
</pre></div>
</div>
<h4><span class="mw-headline" id="Discussion_2">Discussion</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=6" title="Edit section: Discussion">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p><b>Spark:</b> This is simply because a client will usually run at a higher FPS, so prediction isn't limited to the ~50ms steps of the server (a client will predict movement between those 50ms steps).</p>
<h3><span class="mw-headline" id="The_Pawn_class">The Pawn class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=7" title="Edit section: The Pawn class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> PredictedPawn <span class="kw1">extends</span> <span class="kw9">xPawn</span>;
 
<span class="kw1">var</span> LocationTrail LocationTrail;  <span class="co1">// The actual trail of locations</span>
<span class="kw1">var</span> <span class="kw5">vector</span> SavedLocation;         <span class="co1">// Used to restore location after timeshifting</span>
<span class="kw1">var</span> <span class="kw5">Rotator</span> SavedRotation;
<span class="kw1">var</span> <span class="kw5">float</span> SavedTimeStamp;
<span class="kw1">var</span> <span class="kw5">float</span> MaxTrailSeconds;        <span class="co1">// How many seconds should be stored in trails</span>
 
 
<span class="kw1">event</span> <span class="kw4">Tick</span><span class="br0">(</span> <span class="kw5">float</span> DeltaTime <span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw1">local</span> LocationTrail Trail;
 
	<span class="kw6">Super</span>.<span class="kw4">Tick</span><span class="br0">(</span>DeltaTime<span class="br0">)</span>;
 
	<span class="co1">// Store the new position and rotation in a LocationTrail</span>
	Trail <span class="sy0">=</span> <span class="kw1">new</span> <span class="br0">(</span><span class="kw5">none</span><span class="br0">)</span> <span class="kw1">class</span><span class="st0">'LocationTrail'</span>;
	Trail.<span class="me0">Next</span> <span class="sy0">=</span> LocationTrail;
	LocationTrail <span class="sy0">=</span> Trail;
 
	LocationTrail.<span class="kw7">Location</span> <span class="sy0">=</span> <span class="kw7">Location</span>;
	LocationTrail.<span class="kw7">Rotation</span> <span class="sy0">=</span> <span class="kw7">Rotation</span>;
	<span class="co1">// Using the timestamp which was saved at roundbegin and will be sent to the client</span>
	LocationTrail.<span class="me0">TimeStamp</span> <span class="sy0">=</span> PredictionReplicationInfo<span class="br0">(</span><span class="kw7">Level</span>.<span class="kw7">Game</span>.<span class="me0">GameReplicationInfo</span><span class="br0">)</span>.<span class="me0">PackageTimeStamp</span>;
 
	<span class="co1">// Free outdated LocationTrails</span>
	<span class="kw2">for</span> <span class="br0">(</span> Trail<span class="sy0">=</span>LocationTrail; Trail<span class="sy0">!=</span><span class="kw5">None</span>; Trail<span class="sy0">=</span>Trail.<span class="me0">next</span> <span class="br0">)</span>
	<span class="br0">{</span>
		<span class="kw2">if</span> <span class="br0">(</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span> <span class="sy0">-</span> Trail.<span class="me0">TimeStamp</span> <span class="sy0">&gt;</span> MaxTrailSeconds <span class="br0">)</span>
		<span class="br0">{</span>
			Trail.<span class="me0">Next</span> <span class="sy0">=</span> <span class="kw5">None</span>;
			<span class="kw2">break</span>;
		<span class="br0">}</span>
	<span class="br0">}</span>
<span class="br0">}</span>
 
<span class="kw1">defaultproperties</span>
<span class="br0">{</span>
	MaxTrailSeconds<span class="sy0">=</span><span class="nu0">0.4</span>;
<span class="br0">}</span>
</pre></div>
</div>
<h4><span class="mw-headline" id="Discussion_3">Discussion</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=8" title="Edit section: Discussion">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p><b>Spark:</b> I'm not sure if Tick() is the best place to store the trails. But it works and is pretty simple. It might be smarter to do this directly after playermovement though, but I couldn't find a place to hook this in (there probably is none, because actor movement is native).</p>
<p>I use PackageTimeStamp for the timestamp because I wasn't sure weither ServerTime gets modified during a tick. It probably doesn't, in this case it would make no difference to use Level.ServerTime instead.</p>
<h3><span class="mw-headline" id="The_Weapon_class">The Weapon class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=9" title="Edit section: The Weapon class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>We need to modify each weapon that is supposed to be unlagged, so we need a new weaponclass. Should we need a lot of unlagged weapons, it would make sense to create a new baseclass but for this example there will be only one gun (a modified EnhancedShockrifle).</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> PredictedShockRifle <span class="kw1">extends</span> SuperShockRifle;
 
<span class="kw1">replication</span>
<span class="br0">{</span>
    <span class="co1">// functions called by client on server</span>
    <span class="kw1">reliable</span> <span class="kw2">if</span><span class="br0">(</span> Role<span class="sy0">&lt;</span><span class="kw7">ROLE_Authority</span> <span class="br0">)</span>
        ServerPredictedStartFire;
<span class="br0">}</span>
 
 
<span class="co1">//// client only ////</span>
<span class="kw1">simulated</span> <span class="kw1">event</span> ClientStartFire<span class="br0">(</span><span class="kw5">int</span> Mode<span class="br0">)</span>
<span class="br0">{</span>
    <span class="kw2">if</span> <span class="br0">(</span><span class="kw9">Pawn</span><span class="br0">(</span><span class="kw7">Owner</span><span class="br0">)</span>.<span class="kw9">Controller</span>.<span class="kw3">IsInState</span><span class="br0">(</span><span class="st0">'GameEnded'</span><span class="br0">)</span><span class="br0">)</span>
        <span class="kw2">return</span>;
 
    <span class="kw2">if</span> <span class="br0">(</span><span class="kw7">Role</span> <span class="sy0">&lt;</span> <span class="kw7">ROLE_Authority</span><span class="br0">)</span>
    <span class="br0">{</span>
        <span class="kw2">if</span> <span class="br0">(</span>StartFire<span class="br0">(</span>Mode<span class="br0">)</span><span class="br0">)</span>
        <span class="br0">{</span>
			ServerPredictedStartFire<span class="br0">(</span> Mode, PredictionReplicationInfo<span class="br0">(</span><span class="kw9">PlayerController</span><span class="br0">(</span><span class="kw7">Instigator</span>.<span class="kw9">Controller</span><span class="br0">)</span>.<span class="me0">GameReplicationInfo</span><span class="br0">)</span>.<span class="me0">PackageTimeStamp</span> <span class="br0">)</span>;
        <span class="br0">}</span>
    <span class="br0">}</span>
    <span class="kw2">else</span>
    <span class="br0">{</span>
        StartFire<span class="br0">(</span>Mode<span class="br0">)</span>;
    <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="co1">//// server only ////</span>
<span class="kw1">event</span> ServerPredictedStartFire<span class="br0">(</span><span class="kw5">byte</span> Mode, <span class="kw5">float</span> ClientTimeStamp<span class="br0">)</span>
<span class="br0">{</span>
    <span class="kw2">if</span> <span class="br0">(</span> <span class="br0">(</span>FireMode<span class="br0">[</span>Mode<span class="br0">]</span>.<span class="me0">NextFireTime</span> <span class="sy0">&lt;=</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span> <span class="sy0">+</span> FireMode<span class="br0">[</span>Mode<span class="br0">]</span>.<span class="me0">PreFireTime</span><span class="br0">)</span>
		<span class="sy0">&amp;&amp;</span> StartFire<span class="br0">(</span>Mode<span class="br0">)</span> <span class="br0">)</span>
    <span class="br0">{</span>
        FireMode<span class="br0">[</span>Mode<span class="br0">]</span>.<span class="me0">ServerStartFireTime</span> <span class="sy0">=</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span>;
	PredictedShockBeamFire<span class="br0">(</span>FireMode<span class="br0">[</span>Mode<span class="br0">]</span><span class="br0">)</span>.<span class="me0">ClientStartFireTime</span> <span class="sy0">=</span> ClientTimeStamp; <span class="co1">// Stupid hack but it works as long as we can trust the FireMode property. Clean code would check if this really is a PredictedShockBeamFire.</span>
        FireMode<span class="br0">[</span>Mode<span class="br0">]</span>.<span class="me0">bServerDelayStartFire</span> <span class="sy0">=</span> <span class="kw6">false</span>;
    <span class="br0">}</span>
    <span class="kw2">else</span>
        FireMode<span class="br0">[</span>Mode<span class="br0">]</span>.<span class="me0">bServerDelayStartFire</span> <span class="sy0">=</span> <span class="kw6">true</span>;
<span class="br0">}</span>
 
 
<span class="kw1">defaultproperties</span>
<span class="br0">{</span>
	FireModeClass<span class="br0">(</span><span class="nu0">0</span><span class="br0">)</span><span class="sy0">=</span>PredictedShockBeamFire;
<span class="br0">}</span>
</pre></div>
</div>
<h4><span class="mw-headline" id="Discussion_4">Discussion</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=10" title="Edit section: Discussion">edit</a><span class="mw-editsection-bracket">]</span></span></h4>
<p><b>Spark:</b> I decided to create a new ServerStartFire function, so the timestamp can be transmitted. ClientStartFire is simply modified to call the new ServerStartFire.</p>
<h3><span class="mw-headline" id="The_WeaponFire_class">The WeaponFire class</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=11" title="Edit section: The WeaponFire class">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p>This is a huge one, so I split it up in even smaller pieces.</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="kw1">class</span> PredictedShockBeamFire <span class="kw1">extends</span> SuperShockBeamFire;
 
<span class="co1">// --- Prediction ---</span>
<span class="kw1">var</span> <span class="kw5">float</span> ClientStartFireTime;	<span class="co1">// This is the time the client actually started shooting</span>
 
<span class="kw1">function</span> DoTrace<span class="br0">(</span><span class="kw5">Vector</span> Start, <span class="kw5">Rotator</span> Dir<span class="br0">)</span>
<span class="br0">{</span>
    <span class="kw1">local</span> <span class="kw5">Vector</span> X, End, HitLocation, HitNormal, RefNormal;
    <span class="kw1">local</span> <span class="kw9">Actor</span> Other;
    <span class="kw1">local</span> <span class="kw5">int</span> Damage;
    <span class="kw1">local</span> <span class="kw5">bool</span> bDoReflect;
    <span class="kw1">local</span> <span class="kw5">int</span> ReflectNum;
 
    ReflectNum <span class="sy0">=</span> <span class="nu0">0</span>;
    <span class="kw2">while</span> <span class="br0">(</span><span class="kw6">true</span><span class="br0">)</span>
    <span class="br0">{</span>
        bDoReflect <span class="sy0">=</span> <span class="kw6">false</span>;
        X <span class="sy0">=</span> <span class="kw5">Vector</span><span class="br0">(</span>Dir<span class="br0">)</span>;
        End <span class="sy0">=</span> Start <span class="sy0">+</span> TraceRange <span class="sy0">*</span> X;
 
		<span class="co1">// *** HIT PREDICTION ***</span>
		<span class="co1">// Timeshift all pawns to make them match the clients reality (hopefully) before doing the trace</span>
		<span class="kw2">if</span> <span class="br0">(</span> ClientStartFireTime <span class="sy0">&gt;</span> <span class="nu0">0</span> <span class="br0">)</span>
			TimeShiftPawns<span class="br0">(</span>ClientStartFireTime<span class="br0">)</span>;
 
        Other <span class="sy0">=</span> <span class="kw4">Trace</span><span class="br0">(</span>HitLocation, HitNormal, End, Start, <span class="kw6">true</span><span class="br0">)</span>;
 
		<span class="co1">// Revert all pawns to their original position</span>
		<span class="kw2">if</span> <span class="br0">(</span> ClientStartFireTime <span class="sy0">&gt;</span> <span class="nu0">0</span> <span class="br0">)</span>
			UnShiftPawns<span class="br0">(</span><span class="br0">)</span>;
 
 
        <span class="kw2">if</span> <span class="br0">(</span> Other <span class="sy0">!=</span> <span class="kw5">None</span> <span class="sy0">&amp;&amp;</span> <span class="br0">(</span>Other <span class="sy0">!=</span> <span class="kw7">Instigator</span> <span class="sy0">||</span> ReflectNum <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">)</span>
        <span class="br0">{</span>
            <span class="kw2">if</span> <span class="br0">(</span>bReflective <span class="sy0">&amp;&amp;</span> Other.<span class="kw3">IsA</span><span class="br0">(</span><span class="st0">'xPawn'</span><span class="br0">)</span> <span class="sy0">&amp;&amp;</span> <span class="kw9">xPawn</span><span class="br0">(</span>Other<span class="br0">)</span>.<span class="me0">CheckReflect</span><span class="br0">(</span>HitLocation, RefNormal, DamageMin<span class="sy0">*</span><span class="nu0">0.25</span><span class="br0">)</span><span class="br0">)</span>
            <span class="br0">{</span>
                bDoReflect <span class="sy0">=</span> <span class="kw6">true</span>;
                HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
            <span class="br0">}</span>
            <span class="kw2">else</span> <span class="kw2">if</span> <span class="br0">(</span><span class="sy0">!</span>Other.<span class="me0">bWorldGeometry</span><span class="br0">)</span>
            <span class="br0">{</span>
                Damage <span class="sy0">=</span> <span class="br0">(</span>DamageMin <span class="sy0">+</span> <span class="kw3">Rand</span><span class="br0">(</span>DamageMax <span class="sy0">-</span> DamageMin<span class="br0">)</span><span class="br0">)</span> <span class="sy0">*</span> DamageAtten;
                Other.<span class="kw4">TakeDamage</span><span class="br0">(</span>Damage, <span class="kw7">Instigator</span>, HitLocation, Momentum<span class="sy0">*</span>X, <span class="kw9">DamageType</span><span class="br0">)</span>;
                HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
            <span class="br0">}</span>
            <span class="kw2">else</span> <span class="kw2">if</span> <span class="br0">(</span> <span class="kw9">WeaponAttachment</span><span class="br0">(</span><span class="kw9">Weapon</span>.<span class="me0">ThirdPersonActor</span><span class="br0">)</span> <span class="sy0">!=</span> <span class="kw5">None</span> <span class="br0">)</span>
				<span class="kw9">WeaponAttachment</span><span class="br0">(</span><span class="kw9">Weapon</span>.<span class="me0">ThirdPersonActor</span><span class="br0">)</span>.<span class="me0">UpdateHit</span><span class="br0">(</span>Other,HitLocation,HitNormal<span class="br0">)</span>;
        <span class="br0">}</span>
        <span class="kw2">else</span>
        <span class="br0">{</span>
            HitLocation <span class="sy0">=</span> End;
            HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
        <span class="br0">}</span>
 
		<span class="co1">// Not here, we will do it clientside. :)</span>
        <span class="co1">// SpawnBeamEffect(Start, Dir, HitLocation, HitNormal, ReflectNum);</span>
 
        <span class="kw2">if</span> <span class="br0">(</span>bDoReflect <span class="sy0">&amp;&amp;</span> <span class="sy0">++</span>ReflectNum <span class="sy0">&lt;</span> <span class="nu0">4</span><span class="br0">)</span>
        <span class="br0">{</span>
            <span class="co1">//Log("reflecting off"@Other@Start@HitLocation);</span>
            Start <span class="sy0">=</span> HitLocation;
            Dir <span class="sy0">=</span> <span class="kw5">Rotator</span><span class="br0">(</span>RefNormal<span class="br0">)</span>; <span class="co1">//Rotator( X - 2.0*RefNormal*(X dot RefNormal) );</span>
        <span class="br0">}</span>
        <span class="kw2">else</span>
        <span class="br0">{</span>
            <span class="kw2">break</span>;
        <span class="br0">}</span>
    <span class="br0">}</span>
<span class="br0">}</span>
</pre></div>
</div>
<p>The only important difference here is, that we timeshift all pawns before we do the hit detection trace. Thsi will get more clear later but it's really the most important thing and why we do all this in fact. This will do the hit detection in the timeframe the client saw when triggering the shot.</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="co1">// Do the beameffect clientside</span>
<span class="kw1">function</span> DoClientTrace<span class="br0">(</span><span class="kw5">Vector</span> Start, <span class="kw5">Rotator</span> Dir<span class="br0">)</span>
<span class="br0">{</span>
    <span class="kw1">local</span> <span class="kw5">Vector</span> X, End, HitLocation, HitNormal, RefNormal;
    <span class="kw1">local</span> <span class="kw9">Actor</span> Other;
    <span class="kw1">local</span> <span class="kw5">bool</span> bDoReflect;
    <span class="kw1">local</span> <span class="kw5">int</span> ReflectNum;
 
    ReflectNum <span class="sy0">=</span> <span class="nu0">0</span>;
    <span class="kw2">while</span> <span class="br0">(</span><span class="kw6">true</span><span class="br0">)</span>
    <span class="br0">{</span>
        bDoReflect <span class="sy0">=</span> <span class="kw6">false</span>;
        X <span class="sy0">=</span> <span class="kw5">Vector</span><span class="br0">(</span>Dir<span class="br0">)</span>;
        End <span class="sy0">=</span> Start <span class="sy0">+</span> TraceRange <span class="sy0">*</span> X;
 
        Other <span class="sy0">=</span> <span class="kw4">Trace</span><span class="br0">(</span>HitLocation, HitNormal, End, Start, <span class="kw6">true</span><span class="br0">)</span>;
 
        <span class="kw2">if</span> <span class="br0">(</span> Other <span class="sy0">!=</span> <span class="kw5">None</span> <span class="sy0">&amp;&amp;</span> <span class="br0">(</span>Other <span class="sy0">!=</span> <span class="kw7">Instigator</span> <span class="sy0">||</span> ReflectNum <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">)</span>
        <span class="br0">{</span>
            <span class="kw2">if</span> <span class="br0">(</span>bReflective <span class="sy0">&amp;&amp;</span> Other.<span class="kw3">IsA</span><span class="br0">(</span><span class="st0">'xPawn'</span><span class="br0">)</span> <span class="sy0">&amp;&amp;</span> <span class="kw9">xPawn</span><span class="br0">(</span>Other<span class="br0">)</span>.<span class="me0">CheckReflect</span><span class="br0">(</span>HitLocation, RefNormal, DamageMin<span class="sy0">*</span><span class="nu0">0.25</span><span class="br0">)</span><span class="br0">)</span>
            <span class="br0">{</span>
                bDoReflect <span class="sy0">=</span> <span class="kw6">true</span>;
                HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
            <span class="br0">}</span>
            <span class="kw2">else</span> <span class="kw2">if</span> <span class="br0">(</span><span class="sy0">!</span>Other.<span class="me0">bWorldGeometry</span><span class="br0">)</span>
            <span class="br0">{</span>
                HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw2">else</span>
        <span class="br0">{</span>
            HitLocation <span class="sy0">=</span> End;
            HitNormal <span class="sy0">=</span> <span class="kw3">Vect</span><span class="br0">(</span><span class="nu0">0</span>,<span class="nu0">0</span>,<span class="nu0">0</span><span class="br0">)</span>;
        <span class="br0">}</span>
 
        SpawnBeamEffect<span class="br0">(</span>Start, Dir, HitLocation, HitNormal, ReflectNum<span class="br0">)</span>;
 
        <span class="kw2">if</span> <span class="br0">(</span>bDoReflect <span class="sy0">&amp;&amp;</span> <span class="sy0">++</span>ReflectNum <span class="sy0">&lt;</span> <span class="nu0">4</span><span class="br0">)</span>
        <span class="br0">{</span>
            <span class="co1">//Log("reflecting off"@Other@Start@HitLocation);</span>
            Start <span class="sy0">=</span> HitLocation;
            Dir <span class="sy0">=</span> <span class="kw5">Rotator</span><span class="br0">(</span>RefNormal<span class="br0">)</span>; <span class="co1">//Rotator( X - 2.0*RefNormal*(X dot RefNormal) );</span>
        <span class="br0">}</span>
        <span class="kw2">else</span>
        <span class="br0">{</span>
            <span class="kw2">break</span>;
        <span class="br0">}</span>
    <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="kw1">function</span> DoClientFireEffect<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>                    
    <span class="kw1">local</span> <span class="kw5">Vector</span> StartTrace;
    <span class="kw1">local</span> <span class="kw5">Rotator</span> R, Aim;
 
    <span class="kw7">Instigator</span>.<span class="kw4">MakeNoise</span><span class="br0">(</span><span class="nu0">1.0</span><span class="br0">)</span>;
 
    <span class="co1">// the to-hit trace always starts right in front of the eye</span>
    StartTrace <span class="sy0">=</span> <span class="kw9">Weapon</span>.<span class="kw7">Owner</span>.<span class="kw7">Location</span> <span class="sy0">+</span> <span class="kw9">Pawn</span><span class="br0">(</span><span class="kw9">Weapon</span>.<span class="kw7">Owner</span><span class="br0">)</span>.<span class="me0">EyePosition</span><span class="br0">(</span><span class="br0">)</span>;
    Aim <span class="sy0">=</span> AdjustAim<span class="br0">(</span>StartTrace, AimError<span class="br0">)</span>;
	R <span class="sy0">=</span> <span class="kw5">rotator</span><span class="br0">(</span><span class="kw5">vector</span><span class="br0">(</span>Aim<span class="br0">)</span> <span class="sy0">+</span> <span class="kw3">VRand</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">*</span><span class="kw3">FRand</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">*</span>Spread<span class="br0">)</span>;
    DoClientTrace<span class="br0">(</span>StartTrace, R<span class="br0">)</span>;
<span class="br0">}</span>
 
<span class="kw1">event</span> ModeDoFire<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw6">Super</span>.<span class="me0">ModeDoFire</span><span class="br0">(</span><span class="br0">)</span>;
 
	<span class="co1">// client</span>
	<span class="kw2">if</span> <span class="br0">(</span><span class="kw7">Instigator</span>.<span class="me0">IsLocallyControlled</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
	<span class="br0">{</span>
		DoClientFireEffect<span class="br0">(</span><span class="br0">)</span>;
	<span class="br0">}</span>
<span class="br0">}</span>
</pre></div>
</div>
<p>This will just render the shockbeam at the clientside. Not sure if it's the best way to do it, as it was just a quick hack to make it work.</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr">
<div class="uscript source-uscript">
<pre class="de1">
<span class="co1">// *** Hit Prediction Timeshifting Functions ***</span>
 
<span class="kw1">function</span> TimeShiftPawns<span class="br0">(</span><span class="kw5">float</span> TimeStamp<span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw1">local</span> <span class="kw9">Controller</span> C;
	<span class="kw1">local</span> PredictedPawn P;
	<span class="kw1">local</span> LocationTrail CurrentTrail, LateTrail, OldTrail;
	<span class="kw1">local</span> <span class="kw5">float</span> interp;
	<span class="kw1">local</span> <span class="kw5">vector</span> LerpedLocation;
	<span class="kw1">local</span> <span class="kw5">Rotator</span> LerpedRotation;
 
	<span class="kw2">for</span> <span class="br0">(</span> C<span class="sy0">=</span><span class="kw7">Level</span>.<span class="me0">ControllerList</span>; C<span class="sy0">!=</span><span class="kw5">None</span>; C<span class="sy0">=</span>C.<span class="me0">NextController</span> <span class="br0">)</span>
	<span class="br0">{</span>
		<span class="co1">// Do not shift the attacker because she should already be where she was when she did the shot.</span>
		<span class="kw2">if</span> <span class="br0">(</span> PredictedPawn<span class="br0">(</span>C.<span class="kw9">Pawn</span><span class="br0">)</span><span class="sy0">!=</span><span class="kw5">None</span> <span class="sy0">&amp;&amp;</span> C.<span class="kw9">Pawn</span> <span class="sy0">!=</span> <span class="kw9">Weapon</span>.<span class="kw7">Owner</span> <span class="br0">)</span>
			P <span class="sy0">=</span> PredictedPawn<span class="br0">(</span>C.<span class="kw9">Pawn</span><span class="br0">)</span>;
		<span class="kw2">else</span>
			<span class="kw2">continue</span>;
 
		LateTrail <span class="sy0">=</span> <span class="kw5">None</span>;
		OldTrail <span class="sy0">=</span> <span class="kw5">None</span>;
 
		<span class="co1">// Find the sandwitching trail timestamps</span>
		<span class="kw2">for</span> <span class="br0">(</span> CurrentTrail<span class="sy0">=</span>P.<span class="me0">LocationTrail</span>; CurrentTrail<span class="sy0">!=</span><span class="kw5">None</span>; CurrentTrail<span class="sy0">=</span>CurrentTrail.<span class="me0">Next</span> <span class="br0">)</span>
		<span class="br0">{</span>
			<span class="kw2">if</span> <span class="br0">(</span> CurrentTrail.<span class="me0">TimeStamp</span> <span class="sy0">&gt;</span> TimeStamp <span class="br0">)</span>
				LateTrail <span class="sy0">=</span> CurrentTrail;
			<span class="kw2">else</span> <span class="kw2">if</span> <span class="br0">(</span> OldTrail <span class="sy0">==</span> <span class="kw5">None</span> <span class="br0">)</span>
				OldTrail <span class="sy0">=</span> CurrentTrail;
			<span class="kw2">else</span>
				<span class="kw2">break</span>;
		<span class="br0">}</span>
 
		<span class="kw2">if</span> <span class="br0">(</span> LateTrail <span class="sy0">!=</span> <span class="kw5">None</span> <span class="sy0">&amp;&amp;</span> OldTrail <span class="sy0">!=</span> <span class="kw5">None</span> <span class="br0">)</span>
		<span class="br0">{</span>
			<span class="co1">// Save original location</span>
			P.<span class="me0">SavedLocation</span> <span class="sy0">=</span> P.<span class="kw7">Location</span>;
			P.<span class="me0">SavedRotation</span> <span class="sy0">=</span> P.<span class="kw7">Rotation</span>;
			P.<span class="me0">SavedTimeStamp</span> <span class="sy0">=</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span>;
 
			<span class="co1">// Interpolate between closest trails and move pawn to this location</span>
			<span class="co1">// Find alpha value for interpolation based on timestamps</span>
			interp <span class="sy0">=</span> <span class="br0">(</span> TimeStamp <span class="sy0">-</span> OldTrail.<span class="me0">TimeStamp</span> <span class="br0">)</span> <span class="sy0">/</span> <span class="br0">(</span> LateTrail.<span class="me0">TimeStamp</span> <span class="sy0">-</span> OldTrail.<span class="me0">TimeStamp</span> <span class="br0">)</span>; 
			interp <span class="sy0">=</span> <span class="kw3">FClamp</span><span class="br0">(</span> interp, <span class="nu0">0</span>, <span class="nu0">1</span> <span class="br0">)</span>;
 
			<span class="co1">//Log("OldTimeStamp: "$OldTrail.TimeStamp$", LateTimeStamp: "$LateTrail.TimeStamp$", TimeStamp: "$TimeStamp);</span>
			<span class="co1">//Log("Resulting Alpha: "$interp); </span>
 
			LerpedLocation.<span class="me0">X</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Location</span>.<span class="me0">X</span>, LateTrail.<span class="kw7">Location</span>.<span class="me0">X</span> <span class="br0">)</span>;
			LerpedLocation.<span class="me0">Y</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Location</span>.<span class="me0">Y</span>, LateTrail.<span class="kw7">Location</span>.<span class="me0">Y</span> <span class="br0">)</span>;
			LerpedLocation.<span class="me0">Z</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Location</span>.<span class="me0">Z</span>, LateTrail.<span class="kw7">Location</span>.<span class="me0">Z</span> <span class="br0">)</span>;
 
			<span class="co1">//Log("OldLocation: "$OldTrail.Location$", LateLocation: "$LateTrail.Location$", LerpedLocation: "$LerpedLocation);</span>
 
			LerpedRotation.<span class="me0">Pitch</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Rotation</span>.<span class="me0">Pitch</span>, LateTrail.<span class="kw7">Rotation</span>.<span class="me0">Pitch</span> <span class="br0">)</span>;
			LerpedRotation.<span class="me0">Yaw</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Rotation</span>.<span class="me0">Yaw</span>, LateTrail.<span class="kw7">Rotation</span>.<span class="me0">Yaw</span> <span class="br0">)</span>;
			LerpedRotation.<span class="me0">Roll</span> <span class="sy0">=</span> <span class="kw3">Lerp</span><span class="br0">(</span> interp, OldTrail.<span class="kw7">Rotation</span>.<span class="me0">Roll</span>, LateTrail.<span class="kw7">Rotation</span>.<span class="me0">Roll</span> <span class="br0">)</span>;
 
			<span class="co1">//Log("OldRotation: "$OldTrail.Rotation$", LateRotation: "$LateTrail.Rotation$", LerpedRotation: "$LerpedRotation);</span>
 
			P.<span class="kw4">SetLocation</span><span class="br0">(</span> LerpedLocation <span class="br0">)</span>;
			P.<span class="kw4">SetRotation</span><span class="br0">(</span> LerpedRotation <span class="br0">)</span>;
		<span class="br0">}</span>
		<span class="kw2">else</span> <span class="kw2">if</span> <span class="br0">(</span> LateTrail <span class="sy0">!=</span> <span class="kw5">None</span> <span class="br0">)</span>
		<span class="br0">{</span>
			<span class="co1">// Save original location</span>
			P.<span class="me0">SavedLocation</span> <span class="sy0">=</span> P.<span class="kw7">Location</span>;
			P.<span class="me0">SavedRotation</span> <span class="sy0">=</span> P.<span class="kw7">Rotation</span>;
			P.<span class="me0">SavedTimeStamp</span> <span class="sy0">=</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span>;
 
			<span class="co1">// TimeStamp is out of reach, move pawn to latest trail</span>
			P.<span class="kw4">SetLocation</span><span class="br0">(</span> LateTrail.<span class="kw7">Location</span> <span class="br0">)</span>;
			P.<span class="kw4">SetRotation</span><span class="br0">(</span> LateTrail.<span class="kw7">Rotation</span> <span class="br0">)</span>;
		<span class="br0">}</span>
	<span class="br0">}</span>
<span class="br0">}</span>
 
<span class="kw1">function</span> UnShiftPawns<span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
	<span class="kw1">local</span> <span class="kw9">Controller</span> C;
	<span class="kw1">local</span> PredictedPawn P;
 
	<span class="kw2">for</span> <span class="br0">(</span> C<span class="sy0">=</span><span class="kw7">Level</span>.<span class="me0">ControllerList</span>; C<span class="sy0">!=</span><span class="kw5">None</span>; C<span class="sy0">=</span>C.<span class="me0">NextController</span> <span class="br0">)</span>
	<span class="br0">{</span>
		<span class="kw2">if</span> <span class="br0">(</span> PredictedPawn<span class="br0">(</span>C.<span class="kw9">Pawn</span><span class="br0">)</span><span class="sy0">!=</span><span class="kw5">None</span> <span class="sy0">&amp;&amp;</span> C.<span class="kw9">Pawn</span> <span class="sy0">!=</span> <span class="kw9">Weapon</span>.<span class="kw7">Owner</span> <span class="br0">)</span>
			P <span class="sy0">=</span> PredictedPawn<span class="br0">(</span>C.<span class="kw9">Pawn</span><span class="br0">)</span>;
		<span class="kw2">else</span>
			<span class="kw2">continue</span>;
 
		<span class="co1">// Make sure that saved location is of this tick before moving</span>
		<span class="kw2">if</span> <span class="br0">(</span> P.<span class="me0">SavedTimeStamp</span> <span class="sy0">==</span> <span class="kw7">Level</span>.<span class="me0">TimeSeconds</span> <span class="br0">)</span>
		<span class="br0">{</span>
			P.<span class="kw4">SetLocation</span><span class="br0">(</span> P.<span class="me0">SavedLocation</span> <span class="br0">)</span>;
			P.<span class="kw4">SetRotation</span><span class="br0">(</span> P.<span class="me0">SavedRotation</span> <span class="br0">)</span>;
		<span class="br0">}</span>
	<span class="br0">}</span>
<span class="br0">}</span>
</pre></div>
</div>
<p>And last but not least the actual timeshifting functions (if more than one weapon is used, those should be moved to a new common base class if possible).</p>
<p>Finally you need a new Gametype or Mutator to replace the Pawn and PlayerController with out custom ones, use the new GameReplicationInfo class and make sure that only our Instagib rifle is used (a modified version of the Instagib mutator will do). I don't post this here because it's a rather common task.</p>
<h3><span class="mw-headline" id="Discussion_5">Discussion</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=12" title="Edit section: Discussion">edit</a><span class="mw-editsection-bracket">]</span></span></h3>
<p><b>Spark:</b> That's it! I hope that those who actually use this code will actively help to improve the code, because a well working hit prediction could be quite important for mods trying to compete with the huge Counter-Strike (and for every other mod featuring hitscan weapons of course). It would be a pity if everyone would have to create this rather common functionality on his own, that's why I wrote this. Another cool thing would be a Mutator replacing all weapons with predicted counterparts that could be used for all basic gametypes. Maybe it would even be possible without subclassing Pawn and PlayerController, but I'm not sure.</p>
<p>Things that should be looked at and really need improvement are:</p>
<dl>
<dt>Resetting the trails</dt>
<dd>If a player respawns or teleports, the trail should be resetted, otherwise the interpolation would move the pawn at a place he never visited. The chance that this leads to an accidental hit is basically null, that's why I didn't bother yet but it's certainly crack.&#160;:) Another thing is, that the trails should probably be cleaned after a pawn is destroyed (not sure if this is automatic).</dd>
<dt>Rapid fire guns</dt>
<dd>Those guns in UT2003 only send StartFire and a StopFire signals, so with the above code, the ClientTimeStamp would also be replicated only once. This means that the ClientFireTime time has to be increased just like the ServerFireTime. This is not a problem (as long as you think of it), but it can lead to inaccuracies with flakey latency. How could this be solved? Maybe constantly replicate the current PackageTimeStamp to the server while shooting?</dd>
<dt>Accuracy</dt>
<dd>The current code seems to be pretty accurate, in tests I could hit reliable with pings up to 400. But still there might be inaccuracies so this should constantly be reviewed and ultimately it would be great to have some usefull debug functions, for example to show the hitbox or a client trace which checks weither you should have hit and then compares this to what the server says. There might be countless other improvements, but I think this is good for a start.</dd>
</dl>
<p><b>capt.k:</b> I made a similar implementation for my UT mod. Haven't extensively tested this, so I dunno if it's any better or worse than what you've got above, but it's pretty much the same except for a couple things: I got around subclassing controller or pawn by using an inventory item which is given to each respawning player to manage each LocationTrail list. LocationTrail is an Actor, so it can now be destroyed on command, and in its Destroyed() it destroys the next link as well  the idea is that it insures that all LocationTrails are eventually removed. If the inventory item is destroyed, it destroys the head of the Trail list, and the head destroys all the children. I also had the LocationTrails only spawed via a timer at intervals of 0.02. Mainly for the sake of uniformity and so we know how many LocationTrails may exist at any given time (and to be consistent w/ Neil Toronto's implementation); again, I dunno if it's any better or worse, but I figure since the position is interpolated anyway, it's an acceptable tradeoff. Unfortunately, I wasn't astute enough to come up with a way to pass the client's timestamp to determine how far back to rewind position to, so instead I just used the player's ping. hth.</p>
<p><b>Spoon:</b></p>
<p>In "PredictedPawn", on the client side, "Level.Game.GameReplicationInfo" is "None" So on the client side you get an "access none" errors. To get rid of the errors, I just wrapped the code block with an "if( ROLE == ROLE_Authority)" so the client can not run the code.</p>
<p>note: I remove the other problem I was having due to a error on my part and not an error related to this code.</p>
<p><b>Xian:</b> Well the code looks nice but those while (True) loops would look scary to me if I'd be a processor&#160;:) Regardless, I was wondering why you're not using Engine.PlayerController.GameReplicationInfo instead of Engine.GameInfo.GameReplicationInfo since the first is replicated on both the Server and Client, and there'd be no need to divide between replication Roles.</p>
<p><b>Graphik:</b> A little tip for you, Xian: you may want to check the revision history on a page before you reply to something said in 2003.&#160;:) Spoon hasn't been around for a while.</p>
<p><b>Xian:</b> I do, but there are people still reading this. And I am just trying to post for them&#160;:)</p>
<p>I for one didn't move from UE1 and don't plan to until UE3 is out. So I am still reading UT related stuff. It doesn't mean that just cos UT2004 is out people will not read 2003 related stuff.</p>
<h2><span class="mw-headline" id="Related_Topics">Related Topics</span><span class="mw-editsection"><span class="mw-editsection-bracket">[</span><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction?section=13" title="Edit section: Related Topics">edit</a><span class="mw-editsection-bracket">]</span></span></h2>
<ul>
<li><a href="Legacy_Lag_Compensation.html" title="Legacy:Lag Compensation">Lag Compensation</a></li>
</ul>
<p><a rel="nofollow" class="external text" href="http://www.planetquake.com/code3arena/tutorials/tutorial41.shtml">Unlagged Tutorial</a> (A hit prediction implementation for Quake 3 Arena)</p>

<!-- 
NewPP limit report
CPU time usage: 0.149 seconds
Real time usage: 0.151 seconds
Preprocessor visited node count: 123/1000000
Preprocessor generated node count: 216/1000000
Postexpand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 - -total
-->

<!-- Saved in parser cache with key wiki:pcache:idhash:1412-0!*!0!!en!*!* and timestamp 20161215143206 and revision id 3574
 -->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="https://wiki.beyondunreal.com/Legacy:Hit_Prediction?oldid=3574">https://wiki.beyondunreal.com/Legacy:Hit_Prediction?oldid=3574</a>"</div>
					<div id='catlinks' class='catlinks catlinks-allhidden'></div>					<!-- end content -->
										<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div id="column-one">
			<h2>Navigation menu</h2>
					<div id="p-cactions" class="portlet" role="navigation">
			<h3>Views</h3>

			<div class="pBody">
				<ul>
				<li id="ca-nstab-legacy" class="selected"><a href="Legacy_Hit_Prediction.html">Legacy</a></li>
				<li id="ca-talk" class="new"><a href="https://wiki.beyondunreal.com/edit/Legacy_talk:Hit_Prediction?redlink=1" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				<li id="ca-edit"><a href="https://wiki.beyondunreal.com/edit/Legacy:Hit_Prediction" title="You can edit this page. Please use the preview button before saving [e]" accesskey="e">Edit</a></li>
				<li id="ca-history"><a href="https://wiki.beyondunreal.com/history/Legacy:Hit_Prediction" title="Past revisions of this page [h]" accesskey="h">History</a></li>
				</ul>
							</div>
		</div>
				<div class="portlet" id="p-personal" role="navigation">
				<h3>Personal tools</h3>

				<div class="pBody">
					<ul>
													<li id="pt-createaccount"><a href="https://wiki.beyondunreal.com/Special:UserLogin?returnto=Legacy%3AHit+Prediction&amp;type=signup" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li>
													<li id="pt-login"><a href="https://wiki.beyondunreal.com/Special:UserLogin?returnto=Legacy%3AHit+Prediction" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
											</ul>
				</div>
			</div>
			<div class="portlet" id="p-logo" role="banner">
				<a href="index.html" class="mw-wiki-logo" title="Visit the main page"></a>
			</div>
				<div class="generated-sidebar portlet" id="p-navigation" role="navigation">
		<h3>Navigation</h3>
		<div class='pBody'>
							<ul>
											<li id="n-mainpage"><a href="index.html" title="Visit the main page [z]" accesskey="z">Main Page</a></li>
											<li id="n-portal"><a href="Unreal_Wiki_Community_portal-2.html" title="About the project, what you can do, where to find things">Community portal</a></li>
											<li id="n-recentchanges"><a href="https://wiki.beyondunreal.com/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
											<li id="n-randompage"><a href="https://wiki.beyondunreal.com/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li>
											<li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="The place to find out">Help</a></li>
											<li id="n-Forums-.28General.29"><a href="https://forums.beyondunreal.com/forums/wiki-general.250/" rel="nofollow">Forums (General)</a></li>
											<li id="n-Forums-.28Technical.29"><a href="https://forums.beyondunreal.com/forums/wiki-technical.251/" rel="nofollow">Forums (Technical)</a></li>
									</ul>
					</div>
		</div>
			<div id="p-search" class="portlet" role="search">
			<h3><label for="searchInput">Search</label></h3>

			<div id="searchBody" class="pBody">
				<form action="https://wiki.beyondunreal.com/" id="searchform">
					<input type='hidden' name="title" value="Special:Search"/>
					<input type="search" name="search" placeholder="Search" title="Search Unreal Wiki [f]" accesskey="f" id="searchInput" />
					<input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" />&#160;
						<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" />
				</form>

							</div>
		</div>
			<div class="portlet" id="p-tb" role="navigation">
			<h3>Tools</h3>

			<div class="pBody">
				<ul>
											<li id="t-whatlinkshere"><a href="https://wiki.beyondunreal.com/Special:WhatLinksHere/Legacy:Hit_Prediction" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
											<li id="t-recentchangeslinked"><a href="https://wiki.beyondunreal.com/Special:RecentChangesLinked/Legacy:Hit_Prediction" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
											<li id="t-specialpages"><a href="https://wiki.beyondunreal.com/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
											<li id="t-print"><a href="https://wiki.beyondunreal.com/Legacy:Hit_Prediction?printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
											<li id="t-permalink"><a href="https://wiki.beyondunreal.com/Legacy:Hit_Prediction?oldid=3574" title="Permanent link to this revision of the page">Permanent link</a></li>
											<li id="t-info"><a href="https://wiki.beyondunreal.com/info/Legacy:Hit_Prediction" title="More information about this page">Page information</a></li>
									</ul>
							</div>
		</div>
			</div><!-- end of the left (by default at least) column -->
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
						<div id="f-copyrightico">
									<a href="https://creativecommons.org/licenses/by-nc-sa/3.0/"><img src="../licensebuttons.net/l/by-nc-sa/3.0/88x31.png" alt="Attribution-Noncommercial-Share Alike 3.0" width="88" height="31" /></a>
							</div>
					<div id="f-poweredbyico">
									<script async src="../pagead2.googlesyndication.com/pagead/js/f.txt"></script>
        <!-- Home Page -->
        <ins class="adsbygoogle"
             style="display:inline-block;width:728px;height:90px"
             data-ad-client="ca-pub-9605963037553244"
             data-ad-slot="9528541415"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
							</div>
					<ul id="f-list">
									<li id="lastmod"> Last modified at 09:51, 11 April 2006.</li>
									<li id="copyright">Licensed as <a href="Unreal_Wiki_Copyrights.html" title="Unreal Wiki:Copyrights">Attribution-Noncommercial-Share Alike 3.0</a>.</li>
									<li id="privacy"><a href="Unreal_Wiki_Privacy_policy.html" title="Unreal Wiki:Privacy policy">Privacy policy</a></li>
									<li id="about"><a href="Unreal_Wiki_About.html" title="Unreal Wiki:About">About Unreal Wiki</a></li>
									<li id="disclaimer"><a href="Unreal_Wiki_General_disclaimer.html" title="Unreal Wiki:General disclaimer">Disclaimers</a></li>
							</ul>
		</div>
		</div>
		<script>if(window.jQuery)jQuery.ready();</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"],null,true);
}</script>
<script>if(window.mw){
document.write("\u003Cscript src=\"https://wiki.beyondunreal.com/w/load.php?debug=false\u0026amp;lang=en\u0026amp;modules=site\u0026amp;only=scripts\u0026amp;skin=monobook\u0026amp;*\"\u003E\u003C/script\u003E");
}</script>
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":86});
}</script></body>
<!-- Mirrored from wiki.beyondunreal.com/Legacy:Hit_Prediction by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 16 Dec 2016 07:56:52 GMT -->
</html>
